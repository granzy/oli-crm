import{h as $,l as O,K as re,_ as ce,b as pe,a as me}from"./index.e9d54774.js";/* empty css               *//* empty css                */import{d as K,f,c as j,w as W,o as Y,aT as Z,D as p,aH as V,aI as t,aS as e,H as c,aY as m,E as D,aU as S,aV as H,aW as w,aZ as z,bY as _e,bt as X,bZ as Q,c6 as ee,aQ as fe,aX as Fe,be as ue,a$ as ve,aO as Ee,c7 as ye,c8 as ge,aM as Le,aN as te,aR as Ae,bI as Be,bJ as Ce,bX as be,aP as he,bo as Ve,bp as De,u as xe,bg as k,c5 as Ie,bi as ke}from"./arco.a97fe066.js";/* empty css              *//* empty css                *//* empty css                */import{f as ae}from"./dict.7add4266.js";import{_ as oe}from"./index.vue_vue_type_script_setup_true_lang.365d06f6.js";import{f as Ue}from"./app-model.480d8620.js";function iu(i){return $.post("/noticeStrategy/pageList",i)}function Se(i){return $.post("/noticeStrategy",i)}function du(i){return $.post("/noticeStrategy/updateEnable",i)}function ru(i){return $.delete(`/noticeStrategy/${i}`)}function we(i){return $.get(`/noticeStrategy/${i}`)}const N=i=>(Be("data-v-d80e9f6c"),i=i(),Ce(),i),Ne=N(()=>c("span",{class:"mini-text"},"\u544A\u8B66\u53D1\u751F\u65F6\uFF0C\u652F\u6301\u4EE5\u4E0B\u65B9\u5F0F\u901A\u77E5\uFF1A",-1)),Re=N(()=>c("span",{class:"mini-text"},"\u544A\u8B66\u53D1\u751F\u540E\uFF0C\u8D85\u8FC7",-1)),Te=N(()=>c("span",{class:"mini-text"},"\u8FD8\u672A\u6062\u590D\uFF0C\u5219\u544A\u8B66\u4F1A\u81EA\u52A8\u5347\u7EA7\u7ED9\u4EE5\u4E0B\u7528\u6237\uFF1A",-1)),qe={style:{display:"flex","margin-top":"16px"}},He=N(()=>c("span",{class:"mini-text"},"\u5347\u7EA7\u7528\u6237\uFF1A",-1)),Oe={key:0,style:{"margin-left":"60px"}},$e=N(()=>c("div",{style:{"margin-top":"16px"}},[c("span",{class:"mini-text"},"\u5347\u7EA7\u901A\u77E5\u65B9\u5F0F\uFF1A")],-1)),Pe=N(()=>c("span",{class:"mini-text"},"\u544A\u8B66\u6062\u590D\u65F6\uFF0C\u652F\u6301\u4EE5\u4E0B\u65B9\u5F0F\u901A\u77E5\uFF1A",-1)),ze={style:{"font-size":"12px"}},Me=K({__name:"notice-step-config",props:{modelValue:{}},emits:["update:modelValue","change"],setup(i,{emit:R}){const A=i,x=R,B=f([]),C=f({type:"HAPPEN",seq:void 0,media:"",mediaList:[],userContactList:[],userIdList:[],upgradeUser:"SELF",upgradeTime:void 0,upgradeUnit:void 0}),F=f({type:"RECOVER",seq:void 0,media:"",mediaList:[],userContactList:[],userIdList:[],upgradeUser:"SELF",upgradeTime:void 0,upgradeUnit:void 0}),o=f([]),b={type:"UPGRADE",seq:0,media:"",mediaList:[],userContactList:[],userIdList:[],upgradeUser:"SELF",upgradeTime:1,upgradeUnit:"minute"},h=j({get(){const n=[C.value,...o.value,F.value];return n.forEach(u=>{u.userContactList=[],u.userIdList&&u.userIdList.length>0&&u.userIdList.forEach(a=>{u.userContactList&&u.userContactList.push({contactId:a,type:"USER"})})}),n},set(n){if(n.length>=2){const u=O.cloneDeep(n);C.value=u[0],o.value=u.splice(1,u.length-2),F.value=u[u.length-1],o.value.forEach(a=>{a.userIdList=a.userContactList.filter(l=>l.type==="USER").map(l=>l.contactId)})}}}),d=()=>{x("update:modelValue",h.value),x("change",h.value)},L=()=>{o.value.length>0&&(o.value.forEach(n=>{n.upgradeUser==="SELF"&&(n.userContactList=[],n.userIdList=[])}),d())},I=()=>{o.value.push(O.cloneDeep(b)),d()},v=n=>{o.value.splice(n,1),d()};W(()=>A.modelValue,n=>{h.value=n},{deep:!0,immediate:!0});const E=async()=>{B.value=(await ae("\u901A\u77E5\u5A92\u4ECB")).data};return Y(()=>{E()}),(n,u)=>{const a=_e,l=X,y=Q,g=ee,T=fe,U=Fe,M=ue,q=ve,G=Ee,P=ye,r=ge,J=Z("svg-icon"),le=Le,ne=re,se=te,ie=Ae;return p(),V(ie,null,{default:t(()=>[e(U,null,{default:t(()=>[e(T,{hoverable:"","body-style":{background:"var(--color-bg-6)"},style:{"border-radius":"4px"}},{default:t(()=>[c("div",null,[e(l,{style:{width:"100%"}},{default:t(()=>[e(a,{color:"blue"},{default:t(()=>[m("\u53D1\u751F")]),_:1}),Ne]),_:1}),e(g,{modelValue:C.value.mediaList,"onUpdate:modelValue":u[0]||(u[0]=s=>C.value.mediaList=s),style:{width:"100%"},onChange:d},{default:t(()=>[(p(!0),D(S,null,H(B.value,s=>(p(),V(y,{key:s.code,value:s.code},{default:t(()=>[m(w(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])])]),_:1},8,["body-style"])]),_:1}),(p(!0),D(S,null,H(o.value,(s,de)=>(p(),V(U,{key:s.seq},{default:t(()=>[e(T,{hoverable:"","body-style":{background:"var(--color-bg-6)"},style:{"border-radius":"4px"}},{default:t(()=>[e(l,{style:{display:"flex",position:"relative"}},{default:t(()=>[e(a,{color:"blue"},{default:t(()=>[m("\u5347\u7EA7")]),_:1}),Re,e(M,{modelValue:s.upgradeTime,"onUpdate:modelValue":_=>s.upgradeTime=_,size:"mini",min:1,max:180,mode:"button",style:{width:"100px"},onChange:d},null,8,["modelValue","onUpdate:modelValue"]),e(G,{modelValue:s.upgradeUnit,"onUpdate:modelValue":_=>s.upgradeUnit=_,size:"mini",style:{width:"80px"},onChange:d},{default:t(()=>[e(q,{value:"minute"},{default:t(()=>[m("\u5206\u949F")]),_:1}),e(q,{value:"hour"},{default:t(()=>[m("\u5C0F\u65F6")]),_:1}),e(q,{value:"day"},{default:t(()=>[m("\u5929")]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"]),Te]),_:2},1024),c("div",qe,[He,e(r,{modelValue:s.upgradeUser,"onUpdate:modelValue":_=>s.upgradeUser=_,size:"mini",onChange:L},{default:t(()=>[e(P,{value:"SELF"},{default:t(()=>[m("\u5347\u7EA7\u7ED9\u81EA\u5DF1")]),_:1}),e(P,{value:"OTHER"},{default:t(()=>[m("\u5347\u7EA7\u7ED9\u6307\u5B9A\u7528\u6237")]),_:1})]),_:2},1032,["modelValue","onUpdate:modelValue"])]),s.upgradeUser==="OTHER"?(p(),D("div",Oe,[e(oe,{modelValue:s.userIdList,"onUpdate:modelValue":_=>s.userIdList=_,onOk:d,onClose:d},null,8,["modelValue","onUpdate:modelValue"])])):z("",!0),$e,e(g,{modelValue:s.mediaList,"onUpdate:modelValue":_=>s.mediaList=_,onChange:d},{default:t(()=>[(p(!0),D(S,null,H(B.value,_=>(p(),V(y,{key:_.code,value:_.code},{default:t(()=>[m(w(_.name),1)]),_:2},1032,["value"]))),128))]),_:2},1032,["modelValue","onUpdate:modelValue"]),e(le,{onClick:_=>v(de)},{default:t(()=>[e(J,{icon:"icon-close",style:{position:"absolute",top:"8px",right:"8px",color:"var(--color-text-1)"}})]),_:2},1032,["onClick"])]),_:2},1032,["body-style"])]),_:2},1024))),128)),e(U,null,{default:t(()=>[e(T,{hoverable:"","body-style":{background:"var(--color-bg-6)"},style:{"border-radius":"4px"}},{default:t(()=>[e(l,{style:{display:"flex"}},{default:t(()=>[e(a,{color:"blue"},{default:t(()=>[m("\u6062\u590D")]),_:1}),Pe]),_:1}),e(l,null,{default:t(()=>[e(g,{modelValue:F.value.mediaList,"onUpdate:modelValue":u[1]||(u[1]=s=>F.value.mediaList=s),onChange:d},{default:t(()=>[(p(!0),D(S,null,H(B.value,s=>(p(),V(y,{key:s.code,value:s.code},{default:t(()=>[m(w(s.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1})]),_:1},8,["body-style"])]),_:1}),e(U,null,{default:t(()=>[e(se,{type:"dashed",class:"add-button-container",onClick:I},{default:t(()=>[e(ne),c("span",ze,w(n.$t("common.push")),1)]),_:1})]),_:1})]),_:1})}}});const Ge=ce(Me,[["__scopeId","data-v-d80e9f6c"]]),Je=c("p",{style:{}},"\u57FA\u672C\u4FE1\u606F",-1),Ke=c("span",{style:{width:"200px"}},"\u5206\u949F\u540E\uFF0C\u544A\u8B66\u5C06\u88AB\u53D1\u9001\u3002",-1),je=c("span",{style:{"font-size":"12px",color:"var(--color-text-3)","align-self":"flex-end"}}," \u82E5\u5728\u6B64\u671F\u95F4\u544A\u8B66\u6062\u590D\uFF0C\u5219\u8BE5\u544A\u8B66\u4E0D\u89E6\u53D1\u901A\u77E5\u3002 ",-1),We=c("div",{style:{display:"flex"}},[c("span",null,"\u901A\u77E5\u6761\u4EF6\uFF08\u975E\u5FC5\u586B\uFF09"),c("span",{style:{"font-size":"12px",color:"var(--color-text-3)","align-self":"flex-end"}}," \u9488\u5BF9\u3010\u6211\u7684\u544A\u8B66\u3011\u8FDB\u884C\u7B5B\u9009\uFF0C\u5C06\u7B26\u5408\u6761\u4EF6\u7684\u544A\u8B66\u901A\u77E5\u7ED9\u5E72\u7CFB\u4EBA\u3002 ")],-1),Xe=c("p",{style:{}},"\u901A\u77E5\u65B9\u5F0F\uFF08\u5FC5\u586B\u53D1\u751F\u548C\u6062\u590D\uFF09",-1),Ye=K({__name:"notice-strategy-save",props:{modelValue:{}},emits:["update:modelValue"],setup(i,{expose:R,emit:A}){const{userInfo:x}=pe(),B=i,C=A,F=f([]),o=f({name:"",priority:"",priorityList:[],delay:0,repeatable:!1,repeatDuration:1,repeatTimes:0,enable:!1,noticeStepList:[],userContactList:[],userIdList:[],ruleFilterList:[],recordEditable:!0}),b=f([]),h=f(),d=f([]),L=f([]),I=j({get(){const u=O.cloneDeep(o.value);return u.priority=o.value.priorityList.join(","),u.noticeStepList=b.value,u.userContactList=[],o.value.userIdList&&o.value.userIdList.length>0&&o.value.userIdList.forEach(a=>{u.userContactList.push({contactId:a,type:"USER"})}),u},set(u){o.value=O.cloneDeep(u),u.priority&&(o.value.priorityList=u.priority.split(",")),o.value.userIdList=u.userContactList.filter(a=>a.type==="USER").map(a=>a.contactId),b.value=u.noticeStepList}}),v=()=>{C("update:modelValue",I.value)},E=async()=>{F.value=(await ae("\u544A\u8B66\u7EA7\u522B")).data;const u=(await Ue()).data.map(l=>l.appInstances).flat();L.value=u.filter(l=>!l.deleteTime).map(l=>l.id);const a=[];u.forEach(l=>{const y={code:l.id,name:l.name};a.push(y)}),o.value.ruleFilterList.forEach(l=>{l.fieldCode==="appKey"&&(l.content=JSON.stringify(JSON.parse(l.content).filter(y=>L.value.indexOf(y)>-1)))}),d.value=[{fieldName:"\u544A\u8B66\u6807\u9898",fieldCode:"information",operators:["eq","ne","like","notLike"],placeHolder:"\u8BF7\u8F93\u5165\u544A\u8B66\u6807\u9898"},{fieldName:"IP\u5730\u5740",fieldCode:"ip",operators:["eq","ne","like","notLike"],placeHolder:"\u8BF7\u8F93\u5165ip\u5730\u5740"},{fieldName:"\u5E94\u7528",fieldCode:"appKey",operators:["in","notIn"],placeHolder:"\u8BF7\u9009\u62E9\u5E94\u7528",meta:{type:"dict",options:a}},{fieldName:"\u76D1\u63A7\u5BF9\u8C61\u540D\u79F0",fieldCode:"displayName",operators:["eq","ne","like","notLike"],placeHolder:"\u8BF7\u8F93\u5165\u76D1\u63A7\u5BF9\u8C61\u540D\u79F0"}]};return R({validRuleFilterHasEmpty:()=>h.value.hasEmpty()}),W(()=>B.modelValue,u=>{I.value=u},{deep:!0,immediate:!0}),Y(()=>{B.modelValue.id||(o.value.userIdList=[x.id]),E()}),(u,a)=>{const l=be,y=he,g=Ve,T=Q,U=ee,M=ue,q=X,G=De,P=Z("Rule-Filter");return p(),D(S,null,[Je,e(l,{margin:10}),e(G,{model:o.value},{default:t(()=>[e(g,{field:"name",label:"\u7B56\u7565\u540D\u79F0",required:""},{default:t(()=>[e(y,{modelValue:o.value.name,"onUpdate:modelValue":a[0]||(a[0]=r=>o.value.name=r),placeholder:"\u8BF7\u8F93\u5165\u7B56\u7565\u540D\u79F0",style:{width:"420px"},"max-length":255,"show-word-limit":"",onInput:v},null,8,["modelValue"])]),_:1}),e(g,{label:"\u544A\u8B66\u7EA7\u522B",required:""},{default:t(()=>[e(U,{modelValue:o.value.priorityList,"onUpdate:modelValue":a[1]||(a[1]=r=>o.value.priorityList=r),onChange:v},{default:t(()=>[(p(!0),D(S,null,H(F.value,r=>(p(),V(T,{key:r.code,value:r.code},{default:t(()=>[m(w(r.name),1)]),_:2},1032,["value"]))),128))]),_:1},8,["modelValue"])]),_:1}),e(g,{field:"userIdList",label:"\u9002\u7528\u4EBA\u5458",rules:[{required:!0,validator:async(r,J)=>{J()}}]},{default:t(()=>[e(oe,{modelValue:o.value.userIdList,"onUpdate:modelValue":a[2]||(a[2]=r=>o.value.userIdList=r),onOk:v,onClose:v},null,8,["modelValue"])]),_:1},8,["rules"]),e(g,{field:"delay",label:"\u5EF6\u8FDF\u7B56\u7565"},{default:t(()=>[c("div",null,[e(q,{style:{width:"100%"}},{default:t(()=>[e(M,{modelValue:o.value.delay,"onUpdate:modelValue":a[3]||(a[3]=r=>o.value.delay=r),min:0,max:180,mode:"button",size:"mini",style:{width:"100px"},onChange:v},null,8,["modelValue"]),Ke]),_:1}),je])]),_:1})]),_:1},8,["model"]),We,e(l,{margin:10}),e(P,{ref_key:"ruleFilter",ref:h,modelValue:o.value.ruleFilterList,"onUpdate:modelValue":a[4]||(a[4]=r=>o.value.ruleFilterList=r),"field-meta":d.value,onChange:v},null,8,["modelValue","field-meta"]),Xe,e(l,{margin:10}),e(Ge,{modelValue:b.value,"onUpdate:modelValue":a[5]||(a[5]=r=>b.value=r),onChange:v},null,8,["modelValue"])],64)}}}),cu=K({__name:"notice-strategy-drawer",props:{id:{type:String,default:""},visible:{type:Boolean,default:!1},mode:{type:String,default:"view"}},emits:["submit","cancel"],setup(i,{emit:R}){const A=i,x=R,{loading:B,setLoading:C}=me(!1),F=f(A.visible),o=f("\u65B0\u5EFA\u7B56\u7565"),b=f(),h={name:"",priority:"",priorityList:[],delay:0,repeatable:!1,repeatDuration:1,repeatTimes:1,enable:!0,noticeStepList:[{type:"HAPPEN",seq:void 0,media:"",mediaList:[],userContactList:[],userIdList:[],upgradeUser:"SELF",upgradeTime:void 0,upgradeUnit:void 0},{type:"RECOVER",seq:void 0,media:"",mediaList:[],userContactList:[],userIdList:[],upgradeUser:"SELF",upgradeTime:void 0,upgradeUnit:void 0}],userIdList:[],userContactList:[],mediaTextSet:[],ruleFilterList:[],recordEditable:!0},d=f(O.cloneDeep(h)),L=j(()=>{switch(o.value){case"\u65B0\u5EFA\u7B56\u7565":case"\u7F16\u8F91\u7B56\u7565":return!0;case"\u7B56\u7565\u8BE6\u60C5":default:return!1}});W([()=>A.visible,()=>A.id],async([E,n])=>{if(E){if(n){const u=(await we(n)).data;u.noticeStepList.forEach(a=>{a.media?a.mediaList=a.media.split(","):a.mediaList=[]}),d.value=u,o.value=u.recordEditable?"\u7F16\u8F91\u7B56\u7565":"\u7B56\u7565\u8BE6\u60C5"}else o.value="\u65B0\u5EFA\u7B56\u7565",d.value=h;F.value=!0}},{deep:!0,immediate:!0});const I=async()=>{const E={...d.value};let n=0,u=!0,a=!0;if(E.noticeStepList.forEach(l=>{l.seq=n,n+=1,l.mediaList.length!==0?l.media=l.mediaList.join(","):u=!1,l.upgradeUser!=="SELF"&&l.userContactList.length===0&&(a=!1)}),!E.name){k.warning("\u540D\u79F0\u4E0D\u53EF\u4E3A\u7A7A\uFF01");return}if(!E.priority){k.warning("\u544A\u8B66\u7EA7\u522B\u4E0D\u53EF\u4E3A\u7A7A\uFF01");return}if(E.userContactList.length===0){k.warning("\u9002\u7528\u4EBA\u5458\u4E0D\u53EF\u4E3A\u7A7A\uFF01");return}if(b.value.validRuleFilterHasEmpty()){k.warning("\u901A\u77E5\u6761\u4EF6\u5185\u5BB9\u4E0D\u53EF\u4E3A\u7A7A\uFF01");return}if(!u){k.warning("\u901A\u77E5\u65B9\u5F0F\u5A92\u4ECB\u4E0D\u53EF\u4E3A\u7A7A\uFF01");return}if(!a){k.warning("\u901A\u77E5\u65B9\u5F0F\u8054\u7CFB\u4EBA\u4E0D\u53EF\u4E3A\u7A7A\uFF01");return}C(!0);try{await Se(E),k.success("\u63D0\u4EA4\u6210\u529F")}finally{C(!1),F.value=!1,x("submit")}},v=()=>{F.value=!1,x("cancel")};return(E,n)=>{const u=te,a=Ie,l=X,y=ke;return p(),D("div",null,[e(y,{width:720,visible:F.value,"ok-loading":xe(B),"unmount-on-close":"","mask-closable":!L.value,footer:L.value,onCancel:v},{title:t(()=>[m(w(o.value),1)]),footer:t(()=>[e(l,null,{default:t(()=>[L.value&&A.mode==="view"?(p(),V(a,{key:0,content:"\u786E\u8BA4\u63D0\u4EA4\u5BF9\u8BE5\u901A\u77E5\u7B56\u7565\u7684\u4FEE\u6539\u4E48?",type:"info",onOk:I},{default:t(()=>[e(u,{type:"primary"},{default:t(()=>[m("\u786E\u8BA4")]),_:1})]),_:1})):z("",!0),L.value&&A.mode==="configure"?(p(),V(u,{key:1,type:"primary",onClick:I},{default:t(()=>[m(" \u786E\u8BA4 ")]),_:1})):z("",!0),L.value?(p(),V(u,{key:2,onClick:n[1]||(n[1]=g=>v())},{default:t(()=>[m(" \u53D6\u6D88 ")]),_:1})):z("",!0)]),_:1})]),default:t(()=>[e(Ye,{ref_key:"noticeStrategySaveRef",ref:b,modelValue:d.value,"onUpdate:modelValue":n[0]||(n[0]=g=>d.value=g)},null,8,["modelValue"])]),_:1},8,["visible","ok-loading","mask-closable","footer"])])}}});export{cu as _,ru as d,iu as q,du as u};
